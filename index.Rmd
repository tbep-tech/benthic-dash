---
title: "TAMPA BAY BENTHIC DASHBOARD"
output: 
  flexdashboard::flex_dashboard:
    logo: www/tarponlogo.png
    social: menu
    source_code: "https://github.com/tbep-tech/benthic-dash"
runtime: shiny
css: styles.css
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = F, message = F, warning = F)

box::use(
  dplyr[`%>%`]
)

cols <- c('#CC3231', '#E9C318', '#2DC938')

maxyr <- 2021

data('sedimentdata', package = 'tbeptools')
load(file = 'data/tbbiscr.RData')
load(file = 'data/benpts.RData')
load(file = 'data/benmed.RData')
load(file = 'data/segs.RData')
load(file = 'data/prmlkup.RData')
load(file = 'data/tbbimat.RData')
```

```{r reactives}
# benthic matrix
benmat <- reactive({
  
  # input
  yrsel1 <- input$yrsel1

  lwid <- 1.5
  
  # base matrix with selected year
  p <- tbbimat +
    ggplot2::geom_hline(yintercept = yrsel1 - 0.5, lwd = lwid) + 
    ggplot2::geom_hline(yintercept = yrsel1 + 0.5, lwd = lwid) + 
    ggplot2::geom_segment(ggplot2::aes(x = 0.5, xend = 0.5, y = yrsel1 - 0.5, yend = yrsel1 + 0.5, lwd = lwid)) +
    ggplot2::geom_segment(ggplot2::aes(x = 9.5, xend = 9.5, y = yrsel1 - 0.5, yend = yrsel1 + 0.5, lwd = lwid))
  
  out <- tbeptools::show_matrixplotly(p, tooltip = 'Action')
  
  return(out)

})

# benthic index map
observe({
  
  # inputs
  yrsel1 <- input$yrsel1
  req(yrsel1)
  
  # polygons
  benpol <- benmed %>% 
    dplyr::filter(yr == yrsel1) %>% 
    dplyr::left_join(segs, ., by = 'bay_segment')
  
  # points
  benpts <- benpts %>% 
    dplyr::filter(yr == yrsel1)
  
  # map with custom legends
  leaflet::leafletProxy('benmap') %>% 
    leaflet::clearMarkers() %>% 
    leaflet::clearShapes() %>% 
    leaflet::addPolygons(
      data = benpol, 
      stroke = T, 
      color = 'grey', 
      weight = 1, 
      layerId = ~bay_segment, 
      fillColor = ~outcome, 
      fillOpacity = 0.3,
      label = ~paste0(bay_segment, ': ', long_name, ', TBBI: ', TBBICat)
    ) %>% 
    leaflet::addCircleMarkers(
      data = benpts, 
      layerId = ~StationID,
      stroke = TRUE,
      color = 'black',
      fill = TRUE,
      fillColor = ~outcome,
      weight = 1,
      fillOpacity = 1,
      radius= 4,
      label = ~paste0('Site ', StationID, ', TBBI: ', round(TBBI, 1), ', Category: ', TBBICat)
    )
  
})

# sediment plot
sedplo <- reactive({
  
  # inputs
  typsel <- input$typsel
  prmsel <- input$prmsel
  yrsel2 <- input$yrsel2
  
  if(typsel == 'PEL summary'){
    
    out <- tbeptools::show_sedimentpelave(sedimentdata, yrrng = yrsel2, plotly = T)
    
  }
  
  if(typsel != 'PEL summary'){
    
    req(prmsel)

    out <- tbeptools::show_sedimentave(sedimentdata, param = prmsel, yrrng = yrsel2, plotly = T)
    
  }
  
  return(out)
  
})

# sediment map
sedmap <- reactive({
  
  # inputs
  typsel <- input$typsel
  prmsel <- input$prmsel
  yrsel2 <- input$yrsel2

  if(typsel == 'PEL summary'){
    
    out <- tbeptools::show_sedimentpelmap(sedimentdata, yrrng = yrsel2)
    
  }
  
  if(typsel != 'PEL summary'){
    
    req(prmsel)
    
    out <- tbeptools::show_sedimentmap(sedimentdata, param = prmsel, yrrng = yrsel2)
    
  }
  
  return(out)
  
})
```

```{r map}

```

```{r downloadhandlers}
```

OVERVIEW
===========================================================

Column {.tabset .tabset-fade data-width=650}
-----------------------------------------------------------------------

### USING THE DASHBOARD

<div class = "row">
<div class = "col-md-2"></div>
<div class = "col-md-8">

#### WELCOME TO THE TAMPA BAY BENTHIC DASHBOARD!

The plots in this dashboard are interactive and display options can be controlled using a mouse. Most plots include a [control menu](https://help.plot.ly/zoom-pan-hover-controls/) on the top with different options for viewing the data.  For example, click the camera icon to download a png file for a plot.

<br>
```{r, fig.align='center', out.width='30%'}
knitr::include_graphics('www/plotcontrols.PNG')
```
<br>

#### Website information

Text

</div>
<div class = "col-md-2"></div>
</div>

### METHODS

<div class = "row">
<div class = "col-md-2"></div>
<div class = "col-md-8">

#### How to understand and use the benthic data

</div>
<div class = "col-md-2"></div>
</div>

### DOWNLOAD DATA

1 TAMPA BAY BENTHIC INDEX
===========================================================

Column {.tabset .tabset-fade data-width=275}
-----------------------------------------------------------------------

### MATRIX RESULTS

```{r}
output$benmat <- plotly::renderPlotly(benmat())
plotly::plotlyOutput('benmat')
```

### Using this tab

This tab shows the overall assessment of the TBBI as management action categories:

Column {data-width=500}
-----------------------------------------------------------------------

### RESULTS BY YEAR

```{r}
bbx <- sf::st_bbox(segs) %>%
  as.numeric()

tbbiscryr <- tbbiscr %>%
  dplyr::filter(yr == maxyr)
benmedyr <- benmed %>%
  dplyr::filter(yr == maxyr) %>%
  dplyr::left_join(segs, ., by = 'bay_segment')
benptsyr <- benpts %>%
  dplyr::filter(yr == maxyr)

# benmapbs
benmapbs <- mapview::mapView(map.types = mapview::mapviewGetOption("basemaps")) %>%
  .@map %>%
  leaflet::fitBounds(lng1 = bbx[1], lng2 = bbx[3], lat1 = bbx[2], lat2 = bbx[4]) %>%
  leaflet::addLegend("topright", labels = c("Good", "Fair", "Poor"), colors = rev(cols), title = "TBBI Category", opacity = 1) %>%
  leaflet::addPolygons(
    data = benmedyr,
    stroke = T,
    color = 'grey',
    weight = 1,
    layerId = ~bay_segment,
    fillColor = ~outcome,
    fillOpacity = 0.3,
    label = ~paste0(bay_segment, ': ', long_name, ', TBBI: ', TBBICat)
  ) %>%
  leaflet::addCircleMarkers(
    data = benptsyr,
    layerId = ~StationID,
    stroke = TRUE,
    color = 'black',
    fill = TRUE,
    fillColor = ~outcome,
    weight = 1,
    fillOpacity = 1,
    radius= 4,
    label = ~paste0('Site ', StationID, ', TBBI: ', round(TBBI, 1), ', Category: ', TBBICat)
  )
output$benmap <- leaflet::renderLeaflet(benmapbs)
fillCol(flex = c(NA, 1),
  column(12,
    column(6,
      sliderInput('yrsel1', 'Select year:', min = 1993, max = maxyr, value = maxyr, step = 1, sep = '', width = '200%', animate = T),
    )
  ),
  leaflet::leafletOutput('benmap')
)
```

2 OVERALL SEDIMENT CONTAMINANTS
===========================================================

Column {.tabset .tabset-fade data-width=275}
-----------------------------------------------------------------------

### SUMMARY RESULTS

```{r}
output$sedplo <- plotly::renderPlotly(sedplo())
plotly::plotlyOutput('sedplo')
```

### Using this tab

Column {data-width=500}
-----------------------------------------------------------------------

### RESULTS FOR YEAR SELECTION

```{r}
output$sedmap <- renderLeaflet({sedmap()})
fillCol(flex = c(NA, 1),
  column(12,
    column(3, 
      selectInput('typsel', 'Select type:', choices = c('PEL summary', c(unique(prmlkup$SedResultsType))))
    ),
    column(3, 
      renderUI({
        typsel <- input$typsel
        
        req(typsel)
        req(typsel != 'PEL summary')
        
        tosel <- prmlkup %>% 
          filter(SedResultsType == typsel) %>% 
          pull(Parameter)
        
        selectInput('prmsel', 'Select parameter:', choices = tosel)
        
      })
    ),
    column(6,
      sliderInput('yrsel2', 'Select year range:', min = 1993, max = maxyr, value = c(1993, maxyr), step = 1, sep = '', width = '200%'),
    )
  ),
  leafletOutput('sedmap')
)
```
